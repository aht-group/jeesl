<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:aup="http://ahtutils.sourceforge.net/prototype"
	xmlns:aht="http://ahtutils.sourceforge.net/jsf"
	xmlns:composite="http://java.sun.com/jsf/composite">

	<composite:interface>
		<composite:attribute name="handler" required="true"/>
		<composite:facet name="resultList" required="false"/>
		<composite:facet name="resultDetail" required="false"/>
	</composite:interface>

	<composite:implementation>
	<h:outputStylesheet library="sbSearch" name="sbSearch.css" target="head" />
	
	<div class="sbSearch jeesl-menu-bar-item jeesl-menu-bar-search jeesl-left">
		<div class="ui-inputgroup">
			<p:commandButton icon="ui-icon ui-icon-search fa fa-search" styleClass="search-btn-light ui-corner-left"  disabled="true" />
			<p:inputText id="searchText" value="#{cc.attrs.handler.searchText}"  placeholder="Search" styleClass="search-box">
				<p:ajax event="keyup" update="searchResults" process="searchText" listener="#{cc.attrs.handler.handleKeyEvent}" oncomplete="showResults()"/>
			</p:inputText>
			<p:commandButton icon="ui-icon ui-icon-close fa fa-times" styleClass="search-btn-light ui-corner-right" onclick="cancelSearch()" update="searchResults" action="#{cc.attrs.handler.cancelEvent}"/>
		</div>
		
		<h:panelGroup id="searchResults" layout="block" styleClass="auContainer jeesl-overlay-container">
			<script>
				function toggleDetails(eventArgs) {
					let currentListItem = $(this).parent();
					let closeRequested = currentListItem.children('.jeesl-field-tip').eq(0).height() > 0;
					
					eventArgs.data.overlay.find('.ui-selectonemenu-item').removeClass('jeesl-active');
					eventArgs.data.overlay.find('.jeesl-field-tip').height(0);
					if (!closeRequested) {
						currentListItem.addClass('jeesl-active');
						let fieldTip = currentListItem.children('.jeesl-field-tip').eq(0);
						fieldTip.height(fieldTip.children('.jeesl-field-tip-content').eq(0).height());
					}
				}
			
				function showResults() {
					let input = $('##{cc.clientId}:searchText'.replaceAll(':','\\:'));
					let overlay = $('##{cc.clientId}:searchResults'.replaceAll(':','\\:'));
					input.val() ? overlay.addClass('jeesl-visible') : overlay.removeClass('jeesl-visible');
					
					overlay.find('.ui-selectonemenu-item-text').click({ overlay: overlay }, toggleDetails);
				}
			</script>
			<div class="jeesl-overlay-wrapper">
				<ul class="ui-selectonemenu-list">
					<ui:repeat var="var" value="#{cc.attrs.handler.list}" varStatus="loop">
						<li class="ui-selectonemenu-item">
							<p:outputPanel class="ui-selectonemenu-item-text">
								<composite:renderFacet name="resultList"/>
							</p:outputPanel>
							<h:panelGroup layout="block" styleClass="jeesl-field-tip" rendered="#{not empty cc.facets.resultDetail}">
		            			<div class="jeesl-field-tip-content">
									<composite:renderFacet name="resultDetail"/>
								</div>
							</h:panelGroup>
						</li>
		        	</ui:repeat>
				</ul>
			</div>
		</h:panelGroup>
	</div>
		
	<h:outputScript library="sbSearch" name="sbSearch.js"/>
		
	</composite:implementation>
</html>